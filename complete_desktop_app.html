<!DOCTYPE html>
<html>
<head>
    <title>AiBeatzbyJyntzu - Complete Desktop Edition</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0f0f0f; color: #fff; font-family: Arial; overflow: hidden; }
        .app-container { height: 100vh; display: flex; flex-direction: column; }
        .header { background: #1f1f1f; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #ffd700; }
        .header h1 { color: #ffd700; font-size: 20px; }
        .theme-selector { padding: 4px 8px; background: #2d2d2d; color: #fff; border: 1px solid #555; border-radius: 4px; }
        .tabs { background: #1a1a1a; display: flex; border-bottom: 1px solid #333; }
        .tab { padding: 12px 20px; background: #2d2d2d; color: #ffd700; border: none; cursor: pointer; border-right: 1px solid #333; font-weight: bold; }
        .tab.active { background: #ffd700; color: #000; }
        .tab:hover { background: #ffed4e; color: #000; }
        .content { flex: 1; overflow-y: auto; padding: 20px; }
        .section { background: #1a1a1a; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .control { display: flex; flex-direction: column; }
        label { color: #ffd700; margin-bottom: 5px; font-weight: bold; font-size: 12px; }
        input, select, textarea, button { padding: 8px; background: #2d2d2d; color: #fff; border: 1px solid #555; border-radius: 4px; }
        button { background: #ffd700; color: #000; cursor: pointer; font-weight: bold; }
        button:hover { background: #ffed4e; }
        .generate-btn { padding: 15px 30px; font-size: 16px; margin: 20px 0; }
        .beat-item { background: #2d2d2d; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ffd700; }
        .beat-controls { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
        audio { flex: 1; }
        .status { padding: 10px; background: #333; border-radius: 4px; margin: 10px 0; }
        .error { background: #d32f2f; }
        .success { background: #4caf50; }
        .chat-container { height: 300px; background: #2d2d2d; border: 2px solid #ffd700; border-radius: 8px; padding: 15px; overflow-y: auto; margin-bottom: 15px; }
        .chat-input { display: flex; gap: 10px; }
        .chat-input input { flex: 1; }
        .analytics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .analytics-card { background: #2d2d2d; padding: 20px; border-radius: 8px; border-left: 4px solid #ffd700; }
        .sampling-controls { background: #2d2d2d; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <!-- License Authentication Screen -->
    <div id="auth-screen" class="app-container" style="justify-content: center; align-items: center; background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);">
        <div style="background: #1f1f1f; padding: 40px; border-radius: 12px; border: 2px solid #ffd700; max-width: 500px; width: 90%; text-align: center;">
            <h1 style="color: #ffd700; margin-bottom: 30px; font-size: 28px;">🎵 AiBeatzbyJyntzu</h1>
            <p style="color: #ccc; margin-bottom: 30px; line-height: 1.6;">Professional AI-Powered Beat Maker<br>Enter your license credentials to continue</p>
            
            <div style="text-align: left; margin-bottom: 20px;">
                <label style="color: #ffd700; display: block; margin-bottom: 8px; font-weight: bold;">Username</label>
                <input type="text" id="authUsername" placeholder="Enter your username" style="width: 100%; padding: 12px; background: #2d2d2d; color: #fff; border: 1px solid #555; border-radius: 6px; font-size: 16px;">
            </div>
            
            <div style="text-align: left; margin-bottom: 30px;">
                <label style="color: #ffd700; display: block; margin-bottom: 8px; font-weight: bold;">Password</label>
                <input type="password" id="authPassword" placeholder="Enter your password" style="width: 100%; padding: 12px; background: #2d2d2d; color: #fff; border: 1px solid #555; border-radius: 6px; font-size: 16px;" onkeypress="if(event.key==='Enter') authenticateUser()">
            </div>
            
            <button onclick="authenticateUser()" style="width: 100%; padding: 15px; background: #ffd700; color: #000; border: none; border-radius: 6px; font-size: 18px; font-weight: bold; cursor: pointer; margin-bottom: 20px;">🔓 Login</button>
            
            <div id="authStatus" style="margin-top: 15px;"></div>
            
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #333; color: #888; font-size: 14px;">
                <p>Need a license? Visit <a href="https://chosen1.cloud" style="color: #ffd700;">chosen1.cloud</a></p>
                <p style="margin-top: 10px;">Pricing: $100 Lifetime • $20/Month • $150/Year • $5/Week</p>
            </div>
        </div>
    </div>

    <div id="main-app" class="app-container" style="display: none;">
        <!-- Header -->
        <div class="header">
            <h1>🎵 AiBeatzbyJyntzu - Complete Desktop Edition</h1>
            <div>
                <select class="theme-selector" onchange="changeTheme(this.value)">
                    <option value="dark-gold">🌙 Dark Gold</option>
                    <option value="cyber-blue">💙 Cyber Blue</option>
                    <option value="neon-purple">💜 Neon Purple</option>
                    <option value="space">🚀 Space</option>
                </select>
                <button onclick="logout()" style="margin-left: 10px;">Logout</button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('studio')">🎵 Studio</button>
            <button class="tab" onclick="showTab('sampling')">🎛️ Sampling</button>
            <button class="tab" onclick="showTab('puter')">🤖 Puter AI</button>
            <button class="tab" onclick="showTab('proposals')">💡 Proposals</button>
            <button class="tab" onclick="showTab('accounts')">👥 Accounts</button>
            <button class="tab" onclick="showTab('analytics')">📊 Analytics</button>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Studio Tab -->
            <div id="studio-tab" class="tab-content">
                <div class="section">
                    <h2 style="color: #ffd700; margin-bottom: 20px;">🎵 Beat Studio</h2>
                    
                    <!-- Beat Mode Selection -->
                    <div style="margin-bottom: 20px;">
                        <label>Beat Generation Mode:</label>
                        <select id="beatMode" onchange="toggleAdvancedOptions()">
                            <option value="inputs">🎛️ Use Inputs (Smart Sampling + AI analysis)</option>
                            <option value="creative">🎨 Creative Direction (concept-based)</option>
                            <option value="description">📝 Description Only</option>
                        </select>
                    </div>

                    <!-- Advanced Sampling Controls -->
                    <div id="advancedSampling" class="sampling-controls">
                        <h3 style="color: #ffd700; margin-bottom: 10px;">🎯 Intelligent Sampling Controls</h3>
                        <div class="controls">
                            <div class="control">
                                <label>Style Era</label>
                                <select id="styleEra">
                                    <option value="modern">🔥 Modern</option>
                                    <option value="old_school">📻 Old School</option>
                                </select>
                            </div>
                            <div class="control">
                                <label>Sample Keyword</label>
                                <input type="text" id="samplingKeyword" placeholder="e.g., dark, piano, vocal, 808">
                            </div>
                            <div class="control">
                                <label>Analysis Mode</label>
                                <select id="audioAnalysis">
                                    <option value="content">🧠 Audio Content Analysis</option>
                                    <option value="filename">📝 Filename Matching</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Creative Direction Controls -->
                    <div id="creativeControls" class="sampling-controls hidden">
                        <h3 style="color: #ffd700; margin-bottom: 10px;">🎨 Creative Direction</h3>
                        <div class="controls">
                            <div class="control">
                                <label>Beat Concept</label>
                                <select id="beatConcept">
                                    <option value="street_life">🏙️ Street Life</option>
                                    <option value="love_story">💕 Love Story</option>
                                    <option value="struggle">💪 Struggle</option>
                                    <option value="success">🏆 Success</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Main Controls -->
                    <div class="controls">
                        <div class="control">
                            <label>Genre</label>
                            <select id="genre">
                                <option>Hip-Hop</option><option>Trap</option><option>Drill</option><option>UK Drill</option>
                                <option>Boom Bap</option><option>Lo-Fi</option><option>Gangsta</option><option>East Coast</option>
                                <option>West Coast</option><option>Dirty South</option><option>Cloud Rap</option><option>Afrobeats</option>
                                <option>Jersey Club</option><option>Phonk</option><option>Rage</option><option>Experimental</option>
                                <option>Memphis</option><option>Crunk</option><option>Hyphy</option><option>Chopped & Screwed</option>
                                <option>G-Funk</option><option>Horrorcore</option><option>Industrial Hip-Hop</option><option>Jazz Rap</option>
                                <option>Alternative Hip-Hop</option><option>Conscious Rap</option><option>Hardcore Hip-Hop</option>
                                <option>EDM</option><option>Pop</option><option>Hyperpop</option><option>Emo</option>
                                <option>Heavy Metal</option><option>Metalcore</option>
                            </select>
                        </div>
                        <div class="control">
                            <label>Mood</label>
                            <select id="mood">
                                <option>Chill</option><option>Aggressive</option><option>Dark</option><option>Energetic</option>
                                <option>Melancholic</option><option>Uplifting</option><option>Sad</option><option>Happy</option>
                                <option>Epic</option><option>Laid Back</option><option>Intense</option><option>Dreamy</option>
                            </select>
                        </div>
                        <div class="control">
                            <label>Tempo: <span id="tempoValue">120</span> BPM</label>
                            <input type="range" id="tempo" min="60" max="180" value="120" oninput="document.getElementById('tempoValue').textContent = this.value">
                        </div>
                        <div class="control">
                            <label>Length: <span id="lengthValue">32</span> bars</label>
                            <input type="range" id="length" min="4" max="120" value="32" oninput="document.getElementById('lengthValue').textContent = this.value">
                        </div>
                        <div class="control">
                            <label>EQ Low: <span id="eqLowValue">0</span> dB</label>
                            <input type="range" id="eqLow" min="-12" max="12" value="0" oninput="document.getElementById('eqLowValue').textContent = this.value">
                        </div>
                        <div class="control">
                            <label>EQ Mid: <span id="eqMidValue">0</span> dB</label>
                            <input type="range" id="eqMid" min="-12" max="12" value="0" oninput="document.getElementById('eqMidValue').textContent = this.value">
                        </div>
                        <div class="control">
                            <label>EQ High: <span id="eqHighValue">0</span> dB</label>
                            <input type="range" id="eqHigh" min="-12" max="12" value="0" oninput="document.getElementById('eqHighValue').textContent = this.value">
                        </div>
                        <div class="control">
                            <label>Complexity</label>
                            <select id="complexity">
                                <option value="simple">🔴 Simple</option>
                                <option value="intermediate" selected>🟡 Intermediate</option>
                                <option value="advanced">🟠 Advanced</option>
                                <option value="expert">🔴 Expert</option>
                            </select>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label>Description & Keywords</label>
                        <textarea id="description" placeholder="Keywords: dark piano, heavy 808, vocal chops..." rows="3" style="width: 100%; margin-top: 5px;"></textarea>
                    </div>

                    <button class="generate-btn" onclick="generateBeat()">🎵 Generate Beat</button>
                    <div id="status"></div>
                </div>

                <!-- Generated Beats -->
                <div class="section">
                    <h2 style="color: #ffd700; margin-bottom: 20px;">Generated Beats</h2>
                    <div id="beats"></div>
                </div>
            </div>

            <!-- Sampling Tab -->
            <div id="sampling-tab" class="tab-content hidden">
                <div class="section">
                    <h2 style="color: #ffd700; margin-bottom: 20px;">🎛️ Advanced Sampling System</h2>
                    <div class="sampling-controls">
                        <h3 style="color: #ffd700; margin-bottom: 10px;">Sampling Settings</h3>
                        <div class="controls">
                            <div class="control">
                                <label>Chopping Method</label>
                                <select id="choppingMethod">
                                    <option value="auto">🤖 Auto Detect</option>
                                    <option value="beats">🥁 Beat-Based</option>
                                    <option value="transients">⚡ Transient-Based</option>
                                    <option value="equal">📏 Equal Segments</option>
                                </select>
                            </div>
                            <div class="control">
                                <label>Style</label>
                                <select id="samplingStyle">
                                    <option value="modern_trap">🔥 Modern Trap</option>
                                    <option value="old_school_boom_bap">📻 Old School Boom Bap</option>
                                    <option value="modern_drill">⚔️ Modern Drill</option>
                                    <option value="old_school_jazz">🎷 Old School Jazz</option>
                                </select>
                            </div>
                        </div>
                        <button onclick="applySamplingToStudio()" style="margin-top: 15px;">🎵 Apply to Beat Studio</button>
                    </div>
                </div>
            </div>

            <!-- Puter AI Tab -->
            <div id="puter-tab" class="tab-content hidden">
                <div class="section">
                    <h2 style="color: #ffd700; margin-bottom: 20px;">🤖 Puter AI Chat</h2>
                    <div style="margin-bottom: 15px;">
                        <label>Chat Mode:</label>
                        <select id="chatContext">
                            <option value="beat">🎵 Beat Generation</option>
                            <option value="lyrics">📝 Lyrics Writing</option>
                            <option value="keywords">🏷️ Keywords & Tags</option>
                            <option value="music">🎶 Music Production</option>
                            <option value="general">💬 General Chat</option>
                        </select>
                    </div>
                    <div class="chat-container" id="chatContainer">
                        <div style="color: #888; font-style: italic; text-align: center; padding-top: 100px;">
                            💬 Start a conversation with Puter AI<br>
                            <span style="font-size: 14px;">Ask about beats, production tips, or music theory!</span>
                        </div>
                    </div>
                    <div class="chat-input">
                        <input type="text" id="chatInput" placeholder="Type your message to Puter AI..." onkeypress="if(event.key==='Enter') sendChat()">
                        <button onclick="sendChat()">Send 📤</button>
                    </div>
                </div>
            </div>

            <!-- Proposals Tab -->
            <div id="proposals-tab" class="tab-content hidden">
                <div class="section">
                    <h2 style="color: #ffd700; margin-bottom: 20px;">💡 Feature Proposals</h2>
                    <p style="color: #ccc; margin-bottom: 20px;">Go to Puter AI chat, select "App Ideas & Features" mode, and describe your idea!</p>
                    <div id="proposalsList"></div>
                </div>
            </div>

            <!-- Accounts Tab -->
            <div id="accounts-tab" class="tab-content hidden">
                <div class="section">
                    <h2 style="color: #ffd700; margin-bottom: 20px;">👥 Account Management</h2>
                    <button onclick="createAccount()" style="margin-bottom: 20px;">Create New Account</button>
                    <div id="accountsList"></div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics-tab" class="tab-content hidden">
                <div class="section">
                    <h2 style="color: #ffd700; margin-bottom: 20px;">📊 Analytics Dashboard</h2>
                    <div class="analytics-grid" id="analyticsGrid"></div>
                </div>
                
                <!-- Enhanced Learning System -->
                <div class="section">
                    <h2 style="color: #ffd700; margin-bottom: 20px;">🧠 AI Learning System</h2>
                    <div class="controls">
                        <div class="control">
                            <label>User ID</label>
                            <input type="text" id="learningUserId" placeholder="Enter User ID" value="demo_user">
                        </div>
                        <div class="control">
                            <button onclick="loadUserProfile()">Load Profile</button>
                        </div>
                        <div class="control">
                            <button onclick="getAIRecommendations()">🧠 Get AI Recommendations</button>
                        </div>
                    </div>
                    <div id="userLearningStats" class="analytics-grid"></div>
                    <div id="aiRecommendations"></div>
                </div>
                
                <!-- Enhanced Beat Generation -->
                <div class="section">
                    <h2 style="color: #ffd700; margin-bottom: 20px;">🎵 Smart Beat Generation</h2>
                    <div class="controls">
                        <div class="control">
                            <label>Complexity Level</label>
                            <select id="smartComplexity">
                                <option value="simple">🔴 Simple (3 layers)</option>
                                <option value="intermediate">🟡 Intermediate (5 layers)</option>
                                <option value="advanced">🟠 Advanced (8 layers)</option>
                                <option value="expert">🔴 Expert (12 layers)</option>
                            </select>
                        </div>
                        <div class="control">
                            <button onclick="generateSmartBeat()">🧠 AI Smart Generate</button>
                        </div>
                    </div>
                    <div id="smartBeatInfo"></div>
                </div>
                
                <!-- Beat Rating System -->
                <div class="section" id="ratingSection" style="display: none;">
                    <h2 style="color: #ffd700; margin-bottom: 20px;">⭐ Rate Beat for AI Learning</h2>
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <span>Rating:</span>
                        <div id="starRating" style="display: flex; gap: 5px;">
                            <span class="star" data-rating="1" style="font-size: 24px; cursor: pointer; color: #666;">★</span>
                            <span class="star" data-rating="2" style="font-size: 24px; cursor: pointer; color: #666;">★</span>
                            <span class="star" data-rating="3" style="font-size: 24px; cursor: pointer; color: #666;">★</span>
                            <span class="star" data-rating="4" style="font-size: 24px; cursor: pointer; color: #666;">★</span>
                            <span class="star" data-rating="5" style="font-size: 24px; cursor: pointer; color: #666;">★</span>
                        </div>
                    </div>
                    <input type="text" id="beatFeedback" placeholder="Optional feedback for AI learning" style="width: 100%; margin-bottom: 15px;">
                    <button onclick="submitBeatRating()">Submit Rating & Train AI</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://jyntzu.pythonanywhere.com';
        
        let beatCount = 0;
        let chatMessages = [];
        let currentAudio = null;
        let currentBeatId = null;
        let selectedRating = 0;
        let isAuthenticated = false;
        let currentUser = null;
        
        // Always require fresh login - no stored credentials
        function initializeApp() {
            // Clear any stored credentials
            localStorage.removeItem('aibeatz_auth');
            showAuthScreen();
        }
        
        function showAuthScreen() {
            document.getElementById('auth-screen').style.display = 'flex';
            document.getElementById('main-app').style.display = 'none';
        }
        
        function showMainApp() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
            
            // Update UI for user type
            if (currentUser && !currentUser.isAdmin) {
                const accountsTab = document.querySelector('[onclick="showTab(\'accounts\')"]');
                if (accountsTab) accountsTab.style.display = 'none';
            }
        }

        // Authentication Functions
        async function authenticateUser() {
            const username = document.getElementById('authUsername').value.trim();
            const password = document.getElementById('authPassword').value.trim();
            
            if (!username || !password) {
                showAuthStatus('Please enter both username and password', 'error');
                return;
            }
            
            showAuthStatus('Authenticating...', 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    isAuthenticated = true;
                    currentUser = { username: data.username, isAdmin: data.is_admin };
                    
                    // Don't store credentials - require login each time
                    
                    showMainApp();
                    showAuthStatus('Login successful!', 'success');
                } else {
                    showAuthStatus(data.error || 'Invalid credentials', 'error');
                }
            } catch (error) {
                showAuthStatus('Connection error: ' + error.message, 'error');
            }
        }
        
        function showAuthStatus(message, type = 'info') {
            const status = document.getElementById('authStatus');
            const colors = {
                'info': '#ffd700',
                'success': '#4caf50',
                'error': '#f44336'
            };
            
            status.innerHTML = `<div style="color: ${colors[type]}; padding: 10px; background: rgba(${type === 'error' ? '244,67,54' : type === 'success' ? '76,175,80' : '255,215,0'}, 0.1); border-radius: 4px; border: 1px solid ${colors[type]};">${message}</div>`;
            
            if (type !== 'error') {
                setTimeout(() => status.innerHTML = '', 3000);
            }
        }

        // Tab Management
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            event.target.classList.add('active');
            
            if (tabName === 'analytics') loadAnalytics();
            if (tabName === 'accounts') loadAccounts();
            if (tabName === 'proposals') loadProposals();
        }

        function toggleAdvancedOptions() {
            const mode = document.getElementById('beatMode').value;
            const advanced = document.getElementById('advancedSampling');
            const creative = document.getElementById('creativeControls');
            
            if (mode === 'creative') {
                advanced.classList.add('hidden');
                creative.classList.remove('hidden');
            } else if (mode === 'inputs') {
                advanced.classList.remove('hidden');
                creative.classList.add('hidden');
            } else {
                advanced.classList.add('hidden');
                creative.classList.add('hidden');
            }
        }

        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.innerHTML = message;
            status.className = 'status ' + type;
            if (type !== 'error') {
                setTimeout(() => status.innerHTML = '', 3000);
            }
        }

        async function generateBeat() {
            const mode = document.getElementById('beatMode').value;
            showStatus('🎵 Generating beat...', 'info');

            const payload = {
                style: `${document.getElementById('styleEra').value}_${document.getElementById('genre').value.toLowerCase()}`,
                tempo: parseInt(document.getElementById('tempo').value),
                bars: parseInt(document.getElementById('length').value),
                keyword: document.getElementById('samplingKeyword').value || document.getElementById('description').value,
                eq: {
                    low: parseInt(document.getElementById('eqLow').value),
                    mid: parseInt(document.getElementById('eqMid').value),
                    high: parseInt(document.getElementById('eqHigh').value)
                },
                description: document.getElementById('description').value,
                mode: mode,
                custom_name: `${document.getElementById('genre').value} ${document.getElementById('mood').value} Beat ${++beatCount}`,
                audio_analysis: document.getElementById('audioAnalysis').value === 'content',
                genre: document.getElementById('genre').value,
                mood: document.getElementById('mood').value,
                complexity: document.getElementById('complexity').value
            };

            if (mode === 'creative') {
                payload.concept = document.getElementById('beatConcept').value;
                payload.era = document.getElementById('styleEra').value;
                payload.intensity = document.getElementById('complexity').value;
            }

            try {
                const endpoint = mode === 'creative' ? 'generate_creative_beat' : 'auto_arrange_beat';
                const response = await fetch(`${API_BASE_URL}/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.status === 'success') {
                    showStatus('✅ Beat generated successfully!', 'success');
                    addBeatToList(data, payload);
                } else {
                    showStatus('❌ ' + (data.error || 'Beat generation failed'), 'error');
                }
            } catch (error) {
                showStatus('❌ Connection error: ' + error.message, 'error');
            }
        }

        function addBeatToList(data, payload) {
            const beatsContainer = document.getElementById('beats');
            const beatDiv = document.createElement('div');
            beatDiv.className = 'beat-item';
            
            const beatUrl = data.beat.url || `${API_BASE_URL}/generated_beats/${data.beat.name}.wav`;
            
            beatDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="color: #ffd700; margin: 0;">${payload.custom_name}</h3>
                        <p style="color: #ccc; margin: 5px 0;">${payload.genre} • ${payload.mood} • ${payload.tempo}BPM • ${payload.bars}bars</p>
                        <p style="color: #888; font-size: 11px;">${data.beat.samples || 'Samples: ' + (data.beat.sample_names ? data.beat.sample_names.slice(0,3).join(', ') + (data.beat.sample_names.length > 3 ? '...' : '') : 'Real samples from libraries')}</p>
                    </div>
                    <a href="${beatUrl}" download style="padding: 8px 16px; background: #4caf50; color: white; text-decoration: none; border-radius: 4px;">📥 Download</a>
                </div>
                <div class="beat-controls">
                    <audio controls style="flex: 1;" loop onplay="handleAudioPlay(this)">
                        <source src="${beatUrl}" type="audio/wav">
                    </audio>
                </div>
            `;
            
            beatsContainer.insertBefore(beatDiv, beatsContainer.firstChild);
        }

        async function sendChat() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            addChatMessage('You', message);
            input.value = '';

            try {
                const response = await fetch(`${API_BASE_URL}/puter_chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        context: document.getElementById('chatContext').value
                    })
                });

                const data = await response.json();
                if (data.status === 'success') {
                    addChatMessage('Puter AI', data.response);
                } else {
                    addChatMessage('System', 'Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                addChatMessage('System', 'Connection error: ' + error.message);
            }
        }

        function addChatMessage(sender, text) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.style.marginBottom = '15px';
            messageDiv.innerHTML = `
                <div style="font-weight: bold; color: ${sender === 'You' ? '#ffd700' : sender === 'Puter AI' ? '#4caf50' : '#f44336'}; margin-bottom: 5px;">
                    ${sender === 'You' ? '👤' : sender === 'Puter AI' ? '🤖' : '⚠️'} ${sender}
                </div>
                <div style="color: #ccc; line-height: 1.4;">${text}</div>
            `;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function applySamplingToStudio() {
            document.getElementById('styleEra').value = document.getElementById('samplingStyle').value.includes('old_school') ? 'old_school' : 'modern';
            document.getElementById('beatMode').value = 'inputs';
            toggleAdvancedOptions();
            showTab('studio');
            showStatus('🎛️ Sampling settings applied to Studio', 'success');
        }

        async function loadAnalytics() {
            try {
                const response = await fetch(`${API_BASE_URL}/stats`);
                const data = await response.json();
                const grid = document.getElementById('analyticsGrid');
                grid.innerHTML = `
                    <div class="analytics-card">
                        <h3 style="color: #ffd700;">🚀 Performance</h3>
                        <p>Memory: ${data.stats.memory_usage.toFixed(1)} MB</p>
                        <p>CPU: ${data.stats.cpu_usage.toFixed(1)}%</p>
                        <p>Uptime: ${data.stats.uptime_formatted}</p>
                    </div>
                    <div class="analytics-card">
                        <h3 style="color: #ffd700;">📈 Usage</h3>
                        <p>Requests: ${data.stats.requests_total}</p>
                        <p>Beats: ${data.stats.beats_generated}</p>
                        <p>Error Rate: ${data.stats.error_rate.toFixed(2)}%</p>
                    </div>
                `;
                
                checkLearningSystemStatus();
            } catch (error) {
                document.getElementById('analyticsGrid').innerHTML = '<p style="color: #f44336;">Failed to load analytics</p>';
            }
        }
        
        async function checkLearningSystemStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/system/learning_status`);
                const data = await response.json();
                
                const grid = document.getElementById('analyticsGrid');
                grid.innerHTML += `
                    <div class="analytics-card">
                        <h3 style="color: #ffd700;">🧠 AI Learning</h3>
                        <p>Learning System: ${data.learning_system_available ? '✅ Active' : '❌ Inactive'}</p>
                        <p>Advanced Engine: ${data.advanced_engine_available ? '✅ Active' : '❌ Inactive'}</p>
                        <p>AI Recommendations: ${data.features.ai_recommendations ? '✅ Available' : '❌ Unavailable'}</p>
                    </div>
                `;
            } catch (error) {
                console.log('Learning system status check failed:', error);
            }
        }
        
        async function loadUserProfile() {
            const userId = document.getElementById('learningUserId').value;
            if (!userId) {
                showStatus('⚠️ Please enter a User ID', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/user/preferences/${userId}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const stats = data.stats;
                    const statsGrid = document.getElementById('userLearningStats');
                    
                    statsGrid.innerHTML = `
                        <div class="analytics-card">
                            <h3 style="color: #ffd700;">📈 User Stats</h3>
                            <p>Total Beats: ${stats.total_beats}</p>
                            <p>Average Rating: ${stats.avg_rating}/5 ⭐</p>
                            <p>Favorite Genre: ${stats.favorite_genre}</p>
                        </div>
                    `;
                    
                    showStatus(`✅ Loaded profile for ${userId}`, 'success');
                } else {
                    showStatus(`❌ Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showStatus(`❌ Connection error: ${error.message}`, 'error');
            }
        }
        
        async function getAIRecommendations() {
            const userId = document.getElementById('learningUserId').value;
            if (!userId) {
                showStatus('⚠️ Please enter a User ID', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/user/preferences/${userId}`);
                const data = await response.json();
                
                if (data.status === 'success' && data.recommendations) {
                    const rec = data.recommendations;
                    const recDiv = document.getElementById('aiRecommendations');
                    
                    recDiv.innerHTML = `
                        <div class="analytics-card" style="background: #1e3a8a; border-left-color: #3b82f6;">
                            <h3 style="color: #ffd700;">🧠 AI Recommendations (${Math.round(rec.confidence * 100)}% confidence)</h3>
                            <p><strong>Genre:</strong> ${rec.genre}</p>
                            <p><strong>Mood:</strong> ${rec.mood}</p>
                            <p><strong>Tempo:</strong> ${rec.tempo} BPM</p>
                            <p><strong>Complexity:</strong> ${rec.complexity}</p>
                            <button onclick="applyAIRecommendations()" style="margin-top: 10px;">Apply to Studio</button>
                        </div>
                    `;
                    
                    window.currentAIRecommendations = rec;
                    showStatus('🧠 AI recommendations loaded', 'success');
                } else {
                    document.getElementById('aiRecommendations').innerHTML = `
                        <div class="analytics-card">
                            <h3 style="color: #ffd700;">🧠 AI Recommendations</h3>
                            <p>No recommendations available yet. Generate and rate some beats first!</p>
                        </div>
                    `;
                    showStatus('📊 No AI recommendations available', 'info');
                }
            } catch (error) {
                showStatus(`❌ Error getting recommendations: ${error.message}`, 'error');
            }
        }
        
        function applyAIRecommendations() {
            if (window.currentAIRecommendations) {
                const rec = window.currentAIRecommendations;
                document.getElementById('genre').value = rec.genre;
                document.getElementById('mood').value = rec.mood;
                document.getElementById('tempo').value = rec.tempo;
                document.getElementById('complexity').value = rec.complexity;
                
                document.getElementById('tempoValue').textContent = rec.tempo;
                
                showTab('studio');
                showStatus('🧠 AI recommendations applied to Studio', 'success');
            }
        }
        
        async function generateSmartBeat() {
            const userId = document.getElementById('learningUserId').value;
            if (!userId) {
                showStatus('⚠️ Please enter a User ID first', 'error');
                return;
            }
            
            const params = {
                user_id: userId,
                complexity: document.getElementById('smartComplexity').value,
                genre: document.getElementById('genre').value,
                mood: document.getElementById('mood').value,
                tempo: parseInt(document.getElementById('tempo').value)
            };
            
            showStatus('🧠 Generating AI-powered smart beat...', 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}/user/smart_generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    displaySmartBeatInfo(data.beat);
                    currentBeatId = data.beat.id;
                    document.getElementById('ratingSection').style.display = 'block';
                    showStatus('✅ Smart beat generated using AI!', 'success');
                } else {
                    showStatus(`❌ Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showStatus(`❌ Connection error: ${error.message}`, 'error');
            }
        }
        
        function displaySmartBeatInfo(beat) {
            const beatDiv = document.getElementById('smartBeatInfo');
            beatDiv.innerHTML = `
                <div class="analytics-card" style="background: #065f46; border-left-color: #10b981;">
                    <h3 style="color: #ffd700;">🎵 ${beat.name}</h3>
                    <p><strong>Genre:</strong> ${beat.genre} | <strong>Mood:</strong> ${beat.mood}</p>
                    <p><strong>Tempo:</strong> ${beat.tempo} BPM | <strong>Complexity:</strong> ${beat.complexity}</p>
                    <p><strong>Engine:</strong> ${beat.engine_used || 'standard'} | <strong>Layers:</strong> ${beat.drums_used + beat.melodies_used}</p>
                    <audio controls style="width: 100%; margin: 10px 0;" onplay="handleAudioPlay(this)">
                        <source src="${beat.url}" type="audio/wav">
                    </audio>
                    <a href="${beat.url}" download="${beat.name}.wav" style="display: inline-block; padding: 8px 16px; background: #4caf50; color: white; text-decoration: none; border-radius: 4px;">Download WAV</a>
                </div>
            `;
        }
        
        async function submitBeatRating() {
            if (!currentBeatId || selectedRating === 0) {
                showStatus('⚠️ Please select a rating first', 'error');
                return;
            }
            
            const userId = document.getElementById('learningUserId').value;
            const feedback = document.getElementById('beatFeedback').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/user/rate_beat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        beat_id: currentBeatId,
                        rating: selectedRating,
                        feedback: feedback
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    showStatus(`✅ Rating submitted: ${selectedRating}/5 stars - AI learning updated!`, 'success');
                    document.getElementById('ratingSection').style.display = 'none';
                    selectedRating = 0;
                    updateStars();
                    document.getElementById('beatFeedback').value = '';
                } else {
                    showStatus(`❌ Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showStatus(`❌ Connection error: ${error.message}`, 'error');
            }
        }

        async function loadAccounts() {
            try {
                const response = await fetch(`${API_BASE_URL}/accounts`);
                const data = await response.json();
                const list = document.getElementById('accountsList');
                list.innerHTML = data.accounts.map(acc => `
                    <div class="beat-item">
                        <h3 style="color: #ffd700;">${acc.username}</h3>
                        <p style="color: #ccc;">Password: ${acc.password}</p>
                        <p style="color: #888; font-size: 11px;">Created: ${acc.created}</p>
                    </div>
                `).join('');
            } catch (error) {
                document.getElementById('accountsList').innerHTML = '<p style="color: #f44336;">Failed to load accounts</p>';
            }
        }

        async function loadProposals() {
            try {
                const response = await fetch(`${API_BASE_URL}/proposals`);
                const data = await response.json();
                const list = document.getElementById('proposalsList');
                list.innerHTML = data.proposals.map(prop => `
                    <div class="beat-item">
                        <h3 style="color: #ffd700;">${prop.title}</h3>
                        <p style="color: #ccc;">${prop.description}</p>
                        <p style="color: #888; font-size: 11px;">By ${prop.username} on ${prop.created}</p>
                    </div>
                `).join('');
            } catch (error) {
                document.getElementById('proposalsList').innerHTML = '<p style="color: #f44336;">Failed to load proposals</p>';
            }
        }

        function changeTheme(theme) {
            const themes = {
                'dark-gold': { primary: '#FFD700', bg: '#0f0f0f', secondary: '#1f1f1f' },
                'cyber-blue': { primary: '#00FFFF', bg: '#001122', secondary: '#003366' },
                'neon-purple': { primary: '#FF00FF', bg: '#2D0A4E', secondary: '#4A1B7A' },
                'space': { primary: '#9370DB', bg: '#000000', secondary: '#0A0A0A' }
            };
            
            const colors = themes[theme] || themes['dark-gold'];
            document.documentElement.style.setProperty('--primary', colors.primary);
            document.documentElement.style.setProperty('--bg', colors.bg);
            document.documentElement.style.setProperty('--secondary', colors.secondary);
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                isAuthenticated = false;
                currentUser = null;
                localStorage.removeItem('aibeatz_auth');
                
                showAuthScreen();
                document.getElementById('authUsername').value = '';
                document.getElementById('authPassword').value = '';
                document.getElementById('authStatus').innerHTML = '';
            }
        }

        function handleAudioPlay(audioElement) {
            if (currentAudio && currentAudio !== audioElement) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
            }
            currentAudio = audioElement;
        }

        function highlightStars(rating) {
            const stars = document.querySelectorAll('.star');
            stars.forEach((star, index) => {
                star.style.color = index < rating ? '#FFD700' : '#666';
            });
        }
        
        function updateStars() {
            highlightStars(selectedRating);
        }
        
        async function checkForUpdates() {
            try {
                const response = await fetch('https://api.github.com/repos/6odevi7/aibeatzbyJyntzu/releases/latest');
                const data = await response.json();
                const latestVersion = data.tag_name;
                const currentVersion = 'v1.0.0';
                
                if (latestVersion !== currentVersion) {
                    showStatus(`🔄 Update available: ${latestVersion}. Restart app to update.`, 'info');
                }
            } catch (error) {
                console.log('Update check failed:', error);
            }
        }

        window.onload = async function() {
            // Always show login screen first
            initializeApp();
            
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                if (response.ok) {
                    console.log('Backend connected');
                    checkForUpdates();
                } else {
                    console.log('Backend issues detected');
                }
            } catch (error) {
                console.log('Backend connection failed:', error);
            }
            
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('star')) {
                    selectedRating = parseInt(e.target.dataset.rating);
                    updateStars();
                }
            });
            
            document.addEventListener('mouseover', function(e) {
                if (e.target.classList.contains('star')) {
                    const rating = parseInt(e.target.dataset.rating);
                    highlightStars(rating);
                }
            });
            
            document.getElementById('starRating').addEventListener('mouseleave', function() {
                updateStars();
            });
            
            setInterval(checkForUpdates, 30 * 60 * 1000);
            
            // Force logout button to clear everything
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.shiftKey && e.key === 'L') {
                    localStorage.removeItem('aibeatz_auth');
                    location.reload();
                }
            });
        };
    </script>
</body>
</html>